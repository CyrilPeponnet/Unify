FROM gliderlabs/alpine

RUN apk add --update \
    python \
    py-pip \
    bash \
    dnsmasq \
    && rm -rf /var/cache/apk/*

RUN mkdir -p /app /etc/dnsmasq.d

WORKDIR /app

COPY 411.py requirements.txt /app/

RUN /usr/bin/pip install -r /app/requirements.txt

ENV CONSUL consul
ENV LISTEN "-L services"
ENV EXTERNAL ""

EXPOSE 53 53/udp

CMD ["sh", "-c", "/usr/bin/python 411.py --consul ${CONSUL} ${LISTEN} ${EXTERNAL} -o /etc/dnsmasq.d/autogenerated -p 'test -f /var/run/dnsmasq.pid && kill -9 $(cat /var/run/dnsmasq.pid); dnsmasq'"]
