FROM gliderlabs/alpine

RUN apk add --update \
    python \
    py-pip \
    bash \
    dnsmasq \
    && rm -rf /var/cache/apk/*

RUN mkdir -p /app /etc/dnsmasq.d

WORKDIR /app

COPY 411.py requirements.txt /app/

RUN /usr/bin/pip install -r /app/requirements.txt

ENV CONSUL consul
ENV KV ""
ENV EXTERNAL ""
ENV MODE "listen"
ENV NOTIFY ""
ENV DOMAIN ""

EXPOSE 53 53/udp

CMD ["sh", "-c", "/usr/bin/python -u 411.py ${MODE} --consul ${CONSUL} ${DOMAIN} ${KV} ${EXTERNAL} ${NOTIFY} -o /etc/dnsmasq.d/autogenerated -r 'test -f /var/run/dnsmasq.pid && kill -9 $(cat /var/run/dnsmasq.pid); dnsmasq'"]
