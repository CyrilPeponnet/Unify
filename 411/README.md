# 411

Python script to create DNS A and CNAME records from:
* consul
* hosts file like dumps
to:
* dnsmasq conf file for CNAME records
* dnsmasq hosts file for A records
* aws route53 A and CNAME records

## Diagram

<p align="center">
    <img src="https://dl.dropboxusercontent.com/u/2663552/Github/Unify/411.jpg" width="800px">
</p>

## How to use

```
usage: 411.py [-h] [-c CONSUL] [-e EXTERNAL_HOSTS_FILES] [-d DATACENTER]
              [-o OUTPUT] [-p POST] [-l] [-L LISTEN] [--dryrun]

optional arguments:
  -h, --help            show this help message and exit
  -c CONSUL, --consul CONSUL
                        Address of one of your consul node
  -e EXTERNAL_HOSTS_FILES, --external_hosts_files EXTERNAL_HOSTS_FILES
                        External hosts file to merge
  -d DATACENTER, --datacenter DATACENTER
                        Datacenter filter. If not provided will use the
                        default datacenter from the agent
  -o OUTPUT, --output OUTPUT
                        Output hosts file that will be generated (if not
                        provided will print the output
  -p POST, --post POST  Command line to run when the outfile is generated (and
                        if it changes)
  -l, --list            Just list the records you have in Route53. This will
                        iterate over boto profiles.
  -L LISTEN, --listen LISTEN
                        Listen to events in consul. Can be either service, or
                        path/to/key or both
  --dryrun              Don't do anything but print what it will do.
```

### Example

`python /root/Unify/411/411.py -c <consul_address> -e <external_host_files> -o <autogenerated_prefix> -p <cmd_to_run>`

will generate two files:
*  `<autogenerated_prefix>.hosts` with A records
*  `<autogenerated_prefix>.conf` with CNAME records

### AWS Route 53

By default it will try to fetch and create records for domains fetched from sources.

If you want to manage your domain/subdomain with AWS, you need to create:

`~/.boto` contanining:

```
[profile my.domain.tld]
aws_access_key_id = XXX
aws_secret_access_key = XXX
```

You can list the records (this will iterate on aws profile defined) with:

`python /root/Unify/411/411.py -l`

### Self hosted solution

Using the provided Dockerfile, you can have a self hosted solution. This container require the capability `NET_ADMIN` upon start.

The ending container will include:
* 411 script listening for consul envents
* dnsmasq daemon

The only things you will need to provide are:
* volume with your own dnsmasq configuration (make sure to include all `.conf` file in your `dnsmasq.conf` main config)
* volume with you profiles aws credentials (`boto.cfg` file mapped to `/etc/boto.cfg`)

Example of usage:

`docker run -d -p 53:53/tcp -p 53:53/udp --cap-add=NET_ADMIN -v /path/dnsmasq/dnsmasq.d:/etc/dnsmasq.d -v /path/dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf -v /path/boto.cfg:/etc/boto.cfg -e CONSUL=<consul_address> -e LISTEN='-L services -L /path/to/kv' -e EXTERNAL='/path/to/external/hostfile' 411`

Using `-L services -L /path/to/kv` will allow `411` to get triggered when there is a service change in consul or if the `/path/to/kv` key is updated in the consul datastore.

Example of default configuration for dnsmasq:

```dnsmasq.conf
no-resolv
# Upstream DNS forwarder
server=IP1
server=IP2
interface=eth0
no-dhcp-interface=eth0
no-hosts
expand-hosts
domain=your.domain.tld
log-queries
conf-dir=/etc/dnsmasq.d/,.hosts
```

Please note the `conf-dir=/etc/dnsmasq.d/,.hosts` which will include all `*.conf` files and discard `*.hosts` files. To include `*.hosts` files you must ensure to have a line like `addn-hosts=/etc/dnsmasq.d/custom.hosts` in your `/etc/dnsmasq.d/custom.conf` file.

Example of custom file:

/etc/dnsmasq.d/custom.conf

```
server=/your.domain.tld/<consul_ip>#8600
addn-hosts=/etc/dnsmasq.d/custom.hosts
```

/etc/dnsmasq.d/custom.hosts

```
10.0.0.1 test.your.domain.tld test
```

Example of boto.cfg

```
[profile sub1.your.domain.tld]
aws_access_key_id = xxxxxxx
aws_secret_access_key = xxxxxxxx

[profile sub2.your.domain.tld]
aws_access_key_id = xxxxxxx
aws_secret_access_key = xxxxxxxx
```