# 411

Python script to create DNS A and CNAME records from:
* consul
* hosts file like dumps
to:
* dnsmasq conf file for CNAME records
* dnsmasq hosts file for A records
* aws route53 A and CNAME records

## Diagram

<p align="center">
    <img src="https://dl.dropboxusercontent.com/u/2663552/Github/Unify/411.jpg" width="800px">
</p>

## Usage

`411.py -h`

```
411, a tool to create dns entries in AWS, dnsmasq from your published containers and external files.

    This will create the files that need to be commited in different repos.

    Usage: 411.py [COMMAND]

    Commands:
      show:   List all DNS records in your AWS profiles.
      listen: Listen for services and create new records according to.
      slave:  Slave mode, will only generate dnsmasq files from AWS.
```

`411.py show -h`

```
List all DNS records in your AWS profiles found under ~/.aws/credentials.

    Usage: show [-d domain...]

    Options;

        -d, --domain domain           Specify the domain(s) to list records

```

`411.py listen -h`

```
Listen for services in consul datastore and create/delete/modify DNS entries according to.

    Usage: listen [options] [-k path...] [-e file...] [-d domain...]

    Options:
        -c, --consul host               Consul host or ip [default: consul].
        --datacenter datacenter         Datacenter filter. If not provided will use the default datacenter from the agent.
        -e, --external-file path        Path to an external hosts file(s) to merge.
        -d, --domain domain             Restrict to domain(s) only.
        -o, --output-prefix prefix      The prefix for output files that will be generated for dnsmasq. If not provided will print the output to stdout.
        -r, --run-cmd cmd               The command to run when new dns records are done. Will be executed in a shell.
        -n, --notify path               KV Path in consul datastore of the key to update when done. Can be used to trigger slaves updates.
        -k, --listen-key path           KV Path(s) in consul datastore to listen to, in order to trigger a DNS update. (Used when the external file is updated for example).
        --dryrun                        Don't do anything but print what it will do.
```

`411.py slave -h`

```
Will act as a slave and will update local dnsmasq files from what we have in AWS. This is meant to be used on remote sites to populate a local dnsmasq.

    Usage: slave [-c host -k path... -d domain... -o prefix -r cmd]

    Options:
        -c, --consul host               Consul host or ip [default: consul].
        -d, --domain domain             The domain(s) on which to fetch DNS records.
        -k, --listen-key path           KV Path(s) in consul datastore to listen to, in order to trigger a DNS update. (Used when the master has done update aws).
        -o, --output-prefix prefix      The prefix for output files that will be generated for dnsmasq. If not provided will print the output to stdout.
        -r, --run-cmd cmd               The command to run when new dns records are done. Will be executed in a shell.
```

### Examples

#### Listen mode

This mode is used to listen to new services in consul when a new container is spawned. This will create the requested DNS entries.

`python 411.py listen -d mydomain -c <consul_address> -e <external_host_files> -k netdamin/updated -o <autogenerated_prefix> -r <cmd_to_run> -n 411/updated`

will:

* listen for new services in consul
* listen for key updated in KV datastore on path netadmin/updated
* monitor an external hosts file
* filter events based on the domain set `mydomain` (optionnal)

Then when a new service is created with proper tags, or the KV key is updated will:

*  Create dnsmasq files:
  -  `<autogenerated_prefix>.hosts` with A records
  -  `<autogenerated_prefix>.conf` with CNAME records
*  Update AWS with:
  -  entries from the external file
  -  new services according to tags defined
  -  run the command cmd_to_run in a shell
  -  update the KV entry in datastore 411/updated (this can be used to trigger slaves as explained below)

#### Slave mode

This mode is meant to be used on remote site, just to generate local configuration for dnsmasq (as a cache and reverse dns capability).

`python 411.py slave -c <consul_address> -d mydomain.tld -k 411/updated -o <autogenerated_prefix> -r <cmd_to_run>`

will:

* listen for `411/updated` KV updates
* filter events based on the domain set `mydomain` (optionnal)

Then when this key is updated:

*  Create dnsmasq files:
  -  `<autogenerated_prefix>.hosts` with A records
  -  `<autogenerated_prefix>.conf` with CNAME records
*  Run the command cmd_to_run in a shell

#### Show mode

This mode will only print the content of AWS records for one or several domains.

`python 411.py show -d domain.tld`

### AWS Route 53

#### Profiles

If you want to manage your domain/subdomain with AWS, you need to create:

Example of `.aws/credentials`, see [boto3 configuration](http://boto3.readthedocs.org/en/latest/guide/configuration.html#configuration-files)

```
[sub1.your.domain.tld]
aws_access_key_id = xxxxxxx
aws_secret_access_key = xxxxxxxx

[sub2.your.domain.tld]
aws_access_key_id = xxxxxxx
aws_secret_access_key = xxxxxxxx
```


#### AWS profile permissions required

The minimum set of permissions you will need to set are:

* route53:ChangeResourceRecordSets (or route53:ListResourceRecordSets for a `slave`)
* route53:GetChange
* route53:GetChangeDetails
* route53:ListHostedZones

Example of IAM json policy:

```json
{
    "Statement": [
        {
            "Sid": "",
            "Effect": "Allow",
            "Action": [
                "route53:ChangeResourceRecordSets",
                "route53:GetChange",
                "route53:GetChangeDetails",
                "route53:ListHostedZones"
            ],
            "Resource": [
                "arn:aws:route53:::hostedzone/12343242343"
            ]
        }
    ]
}
```

This is for `listen` mode. For `slave` or `show` mode, you can restrict the permissions to:

```json
{
   "Statement": [
       {
            "Sid": "",
            "Effect": "Allow",
            "Action": [
                "route53:ListHostedZones",
                "route53:GetChange",
                "route53:GetChangeDetails",
                "route53:ListResourceRecordSets"
           ],
           "Effect": "Allow",
           "Resource": [
               "*"
           ]
       }
   ]
}
```


### Self hosted solution

Using the provided Dockerfile, you can have a self hosted solution. This container require the capability `NET_ADMIN` upon start.

The ending container will include:
* 411 script listening for consul envents
* dnsmasq daemon

The only things you will need to provide are:
* volume with your own dnsmasq configuration (make sure to include all `.conf` file in your `dnsmasq.conf` main config)
* volume with you profiles aws credentials (`.aws/credentials` file mapped to `/root/.aws/crendetials`)

Example of usage:

#### For a `listen` mode:

`docker run -d -p 53:53/tcp -p 53:53/udp --cap-add=NET_ADMIN -v /path/dnsmasq/dnsmasq.d:/etc/dnsmasq.d -v /path/dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf -v /path/.aws/credentials:/root/.aws/credentials -e CONSUL=<consul_address> -e KV='-k /path/to/kv -k pat/to/otherkv' -e EXTERNAL='-e /path/to/external/hostfile' -e NOTIFY='-n 411/updated' 411`

Using `KV='-k /path/to/kv -k pat/to/otherkv'` will allow `411` to get triggered when there is a  change in the consul datastore keys. (For example when an external file has been updated by a third party program).
Using `NOTIFY='-n 411/updated'` will update the key if changed has been done. (used to trigger `slaves` for example).

#### For a `slave mode:`

`docker run -d -p 53:53/tcp -p 53:53/udp --cap-add=NET_ADMIN -v /path/dnsmasq/dnsmasq.d:/etc/dnsmasq.d -v /path/dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf -v /path/.aws/credentials:/root/.aws/credentials -e MODE="slave" -e CONSUL=<consul_address> -e KV='-k 411/updated' -e EXTERNAL='-e /path/to/external/hostfile' 411`

Using `KV='-k 411/updated'` will make `411` in `slave` mode to regenerate dnsmasq files and reload dnsmasq when there is a change in aws.

Example of default configuration for dnsmasq:

```dnsmasq.conf
no-resolv
# Upstream DNS forwarder
server=IP1
server=IP2
interface=eth0
no-dhcp-interface=eth0
no-hosts
expand-hosts
domain=your.domain.tld
log-queries
conf-dir=/etc/dnsmasq.d/,.hosts
```

Please note the `conf-dir=/etc/dnsmasq.d/,.hosts` which will include all `*.conf` files and discard `*.hosts` files. To include `*.hosts` files you must ensure to have a line like `addn-hosts=/etc/dnsmasq.d/custom.hosts` in your `/etc/dnsmasq.d/custom.conf` file.

Example of custom file:

/etc/dnsmasq.d/custom.conf

```
server=/your.domain.tld/<consul_ip>#8600
addn-hosts=/etc/dnsmasq.d/custom.hosts
```

/etc/dnsmasq.d/custom.hosts

```
10.0.0.1 test.your.domain.tld test
```



