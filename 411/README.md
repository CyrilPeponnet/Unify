# 411

Python script to create DNS A and CNAME records from:
* consul
* hosts file like dumps
to:
* dnsmasq conf file for CNAME records
* dnsmasq hosts file for A records
* aws route53 A and CNAME records

## Diagram

<p align="center">
    <img src="https://dl.dropboxusercontent.com/u/2663552/Github/Unify/411.jpg" width="800px">
</p>

## Usage

`411.py -h`

```
411, a tool to create dns entries in AWS, dnsmasq from your published containers and external files.

    This will create the files that need to be commited in different repos.

    Usage: 411.py [COMMAND]

    Commands:
      listen: List all DNS records in your AWS profiles.
      show: Listen for services and create new records according to.
```

`411.py show -h`

```
List all DNS records in your AWS profiles found under ~/.aws/credentials.

    Usage: show [-d domain...]

    Options;

        -d, --domain domain           Specify the domain(s) to list records

```

`411.py listen -h`

```
Listen for services in consul datastore and create/delete/modify DNS entries according to.

    Usage: listen [options] [-k path...] [-e file...]

    Options:
        -c, --consul host               Consul host or ip [default: consul].
        -e, --external-file path        Path to an external hosts file(s) to merge.
        -d, --datacenter datacenter     Datacenter filter. If not provided will use the default datacenter from the agent.
        -o, --output-prefix prefix      The prefix for output files that will be generated for dnsmasq. If not provided will print the output to stdout.
        -r, --run-cmd cmd               The command to run when new dns records are done. Will be executed in a shell.
        -k, --listen-key path           KV Path(s) in consul datastore to listen to, in order to trigger a DNS update. (Used when the external file is updated for example).
        --dryrun                        Don't do anything but print what it will do.
```

### Example

`python /root/Unify/411/411.py listen -c <consul_address> -e <external_host_files> -o <autogenerated_prefix> -r <cmd_to_run>`

will generate two files:
*  `<autogenerated_prefix>.hosts` with A records
*  `<autogenerated_prefix>.conf` with CNAME records

### AWS Route 53

By default it will try to fetch and create records for domains pulled from services published in consul.

If you want to manage your domain/subdomain with AWS, you need to create:

`~/.aws/credentials` contanining:

```
[my.domain.tld]
aws_access_key_id = XXX
aws_secret_access_key = XXX
```

You can list the records (this will iterate on aws profile defined) with:

`python 411.py show`

Or only show the domains you want:

`python 411.py show -d mydomain.tld -d myotherdomain.tld`

### Self hosted solution

Using the provided Dockerfile, you can have a self hosted solution. This container require the capability `NET_ADMIN` upon start.

The ending container will include:
* 411 script listening for consul envents
* dnsmasq daemon

The only things you will need to provide are:
* volume with your own dnsmasq configuration (make sure to include all `.conf` file in your `dnsmasq.conf` main config)
* volume with you profiles aws credentials (`.aws/credentials` file mapped to `/root/.aws/crendetials`)

Example of usage:

`docker run -d -p 53:53/tcp -p 53:53/udp --cap-add=NET_ADMIN -v /path/dnsmasq/dnsmasq.d:/etc/dnsmasq.d -v /path/dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf -v /path/.aws/credentials:/root/.aws/credentials -e CONSUL=<consul_address> -e KV='-k /path/to/kv -k pat/to/otherkv' -e EXTERNAL='-e /path/to/external/hostfile' 411`

Using `KV='-k /path/to/kv -k pat/to/otherkv'` will allow `411` to get triggered when there is a  change in the consul datastore keys. (For example when an external file has been updated by a third party program).

Example of default configuration for dnsmasq:

```dnsmasq.conf
no-resolv
# Upstream DNS forwarder
server=IP1
server=IP2
interface=eth0
no-dhcp-interface=eth0
no-hosts
expand-hosts
domain=your.domain.tld
log-queries
conf-dir=/etc/dnsmasq.d/,.hosts
```

Please note the `conf-dir=/etc/dnsmasq.d/,.hosts` which will include all `*.conf` files and discard `*.hosts` files. To include `*.hosts` files you must ensure to have a line like `addn-hosts=/etc/dnsmasq.d/custom.hosts` in your `/etc/dnsmasq.d/custom.conf` file.

Example of custom file:

/etc/dnsmasq.d/custom.conf

```
server=/your.domain.tld/<consul_ip>#8600
addn-hosts=/etc/dnsmasq.d/custom.hosts
```

/etc/dnsmasq.d/custom.hosts

```
10.0.0.1 test.your.domain.tld test
```

Example of `.aws/credentials`, see [boto3 configuration](http://boto3.readthedocs.org/en/latest/guide/configuration.html#configuration-files)

```
[sub1.your.domain.tld]
aws_access_key_id = xxxxxxx
aws_secret_access_key = xxxxxxxx

[sub2.your.domain.tld]
aws_access_key_id = xxxxxxx
aws_secret_access_key = xxxxxxxx
```

## AWS profile permissions required

The minimum set of permissions you will need to set are:

* route53:ChangeResourceRecordSets
* route53:GetChange
* route53:GetChangeDetails
* route53:ListHostedZones

Example of IAM json policy:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "",
            "Effect": "Allow",
            "Action": [
                "route53:ChangeResourceRecordSets",
                "route53:GetChange",
                "route53:GetChangeDetails",
                "route53:ListHostedZones"
            ],
            "Resource": [
                "arn:aws:route53:::hostedzone/12343242343"
            ]
        }
    ]
}
```
